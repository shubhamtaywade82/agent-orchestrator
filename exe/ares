#!/usr/bin/env ruby
# frozen_string_literal: true

require 'ares_runtime'
require 'optparse'

module Ares
  class CLI
    def self.start
      case ARGV.first
      when 'init'    then ARGV.shift; init
      when 'config'  then ARGV.shift; config
      when 'doctor'  then ARGV.shift; doctor
      when 'version' then ARGV.shift; version
      when 'logs'    then ARGV.shift; logs
      else
        run_task
      end
    end

    def self.init
      Ares::Runtime::Initializer.run
    end

    def self.config
      Ares::Runtime::ConfigCLI.run
    end

    def self.doctor
      Ares::Runtime::Doctor.run
    end

    def self.version
      puts "Ares v#{Ares::Runtime::VERSION}"
    end

    def self.logs
      Ares::Runtime::LogsCLI.run
    end

    def self.run_task
      options = {
        dry_run: false,
        git: false,
        tui: false
      }

      OptionParser.new do |opts|
        opts.banner = 'Usage: ares [options] "task description"'

        opts.on('-d', '--dry-run') { options[:dry_run] = true }
        opts.on('-g', '--git')     { options[:git] = true }
        opts.on('--tui')           { options[:tui] = true }
      end.parse!

      if options[:tui]
        Ares::Runtime::Tui.start
        exit
      end

      task = ARGV.join(' ').strip

      if task.empty?
        puts 'No task provided.'
        exit 1
      end

      Ares::Runtime::Router.new.run(task, options)
    end
  end
end

Ares::CLI.start

#!/usr/bin/env ruby
# frozen_string_literal: true

require 'ares_runtime'
require 'optparse'

module Ares
  class CLI
    def self.start
      command = ARGV.shift

      case command
      when 'init'    then init
      when 'config'  then config
      when 'doctor'  then doctor
      when 'version' then version
      when 'logs'    then logs
      else
        run_task(command)
      end
    end

    def self.init
      Initializer.run
    end

    def self.config
      ConfigCLI.run
    end

    def self.doctor
      Doctor.run
    end

    def self.version
      puts "Ares v#{VERSION}"
    end

    def self.logs
      LogsCLI.run
    end

    def self.run_task(first_arg)
      options = {
        dry_run: false,
        git: false,
        tui: false
      }

      OptionParser.new do |opts|
        opts.banner = 'Usage: ares [options] "task description"'

        opts.on('-d', '--dry-run') { options[:dry_run] = true }
        opts.on('-g', '--git')     { options[:git] = true }
        opts.on('--tui')           { options[:tui] = true }
      end.parse!

      if options[:tui]
        Tui.start
        exit
      end

      task = ([first_arg] + ARGV).compact.join(' ').strip

      if task.empty?
        puts 'No task provided.'
        exit 1
      end

      Router.new.run(task, options)
    end
  end
end

Ares::CLI.start
